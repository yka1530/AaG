<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Stream Service</title>
  <style>
    body{font-family:system-ui,Arial;background:#0f1720;color:#e6eef6;margin:0;padding:20px}
    .player{max-width:720px;margin:0 auto;background:#101828;padding:16px;border-radius:10px;box-shadow:0 6px 24px rgba(2,6,23,.6)}
    h1{margin:0 0 12px;font-size:20px}
    .track{display:flex;align-items:center;gap:12px;padding:8px;border-radius:8px;cursor:pointer}
    .track:hover{background:#0b1220}
    .cover{width:56px;height:56px;border-radius:6px;object-fit:cover;background:#06101a}
    .meta{flex:1}
    .meta b{display:block}
    .controls{display:flex;gap:8px;align-items:center;margin-top:12px}
    button{padding:8px 12px;border-radius:8px;border:0;background:#0ea5a4;color:#012;cursor:pointer}
  </style>
</head>
<body>
  <div class="player">
    <h1>مشغل الأغاني</h1>
    <div id="playlist"></div>

    <div class="controls">
      <button id="prev">السابق</button>
      <button id="play">تشغيل</button>
      <button id="next">التالي</button>
      <div id="current" style="margin-left:auto"></div>
    </div>

    <audio id="audio" preload="none"></audio>
  </div>

  <script>
    const manifestUrl = './manifest.json'; // غيره لمكان المانيفست
    const playlistEl = document.getElementById('playlist');
    const audio = document.getElementById('audio');
    const playBtn = document.getElementById('play');
    const prevBtn = document.getElementById('prev');
    const nextBtn = document.getElementById('next');
    const currentEl = document.getElementById('current');

    let tracks = [];
    let idx = 0;
    let playing = false;

    async function loadManifest(){
      const r = await fetch(manifestUrl);
      tracks = await r.json();
      renderList();
      loadTrack(0);
    }

    function renderList(){
      playlistEl.innerHTML = '';
      tracks.forEach((t,i)=>{
        const el = document.createElement('div');
        el.className = 'track';
        el.innerHTML = `
          <img class="cover" src="${t.cover || ''}" alt="cover" onerror="this.style.display='none'">
          <div class="meta"><b>${t.title}</b><small>${t.artist || ''}</small></div>
          <div>${formatTime(t.duration)}</div>
        `;
        el.onclick = ()=> { loadTrack(i); playAudio(); }
        playlistEl.appendChild(el);
      });
    }

    function loadTrack(i){
      if(!tracks[i]) return;
      idx = i;
      audio.src = tracks[i].url;
      currentEl.textContent = `${tracks[i].title} — ${tracks[i].artist||''}`;
      highlightCurrent();
    }

    function highlightCurrent(){
      [...playlistEl.children].forEach((c,j)=> c.style.background = j===idx ? '#06202a' : '');
    }

    function playAudio(){
      audio.play().then(()=>{ playing=true; playBtn.textContent='إيقاف' }).catch(e=>{ console.error(e); alert('خطأ في تشغيل الملف أو CORS') });
    }
    function pauseAudio(){ audio.pause(); playing=false; playBtn.textContent='تشغيل' }

    playBtn.addEventListener('click', ()=> {
      if(playing) pauseAudio(); else playAudio();
    });
    prevBtn.addEventListener('click', ()=> { idx = (idx-1+tracks.length)%tracks.length; loadTrack(idx); playAudio(); });
    nextBtn.addEventListener('click', ()=> { idx = (idx+1)%tracks.length; loadTrack(idx); playAudio(); });

    audio.addEventListener('ended', ()=> { nextBtn.click(); });

    function formatTime(t){ return t? new Date(t*1000).toISOString().substr(14,5):'' }

    // البداية
    loadManifest();
  </script>
</body>
</html>
